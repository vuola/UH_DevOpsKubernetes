COMMANDS

(base) vuola@Markuss-MacBook-Air Exercise1_11 % k3d cluster delete
INFO[0000] Deleting cluster 'k3s-default'               
INFO[0018] Deleting cluster network 'k3d-k3s-default'   
INFO[0019] Deleting 2 attached volumes...               
WARN[0019] Failed to delete volume 'k3d-k3s-default-images' of cluster 'k3s-default': failed to find volume 'k3d-k3s-default-images': Error: No such volume: k3d-k3s-default-images -> Try to delete it manually 
INFO[0019] Removing cluster details from default kubeconfig... 
INFO[0019] Removing standalone kubeconfig file (if there is one)... 
INFO[0019] Successfully deleted cluster k3s-default!

(base) vuola@Markuss-MacBook-Air Exercise1_11 % docker container ls
CONTAINER ID   IMAGE     COMMAND   CREATED   STATUS    PORTS     NAMES

(base) vuola@Markuss-MacBook-Air Exercise1_11 % k3d cluster create --port 8082:30080@agent:0 -p 8081:80@loadbalancer --agents 2
INFO[0000] portmapping '8081:80' targets the loadbalancer: defaulting to [servers:*:proxy agents:*:proxy] 
INFO[0000] Prep: Network                                
INFO[0000] Created network 'k3d-k3s-default'            
INFO[0000] Created image volume k3d-k3s-default-images  
INFO[0000] Starting new tools node...                   
INFO[0000] Starting Node 'k3d-k3s-default-tools'        
INFO[0001] Creating node 'k3d-k3s-default-server-0'     
INFO[0001] Creating node 'k3d-k3s-default-agent-0'      
INFO[0001] Creating node 'k3d-k3s-default-agent-1'      
INFO[0001] Creating LoadBalancer 'k3d-k3s-default-serverlb' 
INFO[0001] Using the k3d-tools node to gather environment information 
INFO[0002] Starting new tools node...                   
INFO[0002] Starting Node 'k3d-k3s-default-tools'        
INFO[0003] Starting cluster 'k3s-default'               
INFO[0003] Starting servers...                          
INFO[0004] Starting Node 'k3d-k3s-default-server-0'     
INFO[0012] Starting agents...                           
INFO[0013] Starting Node 'k3d-k3s-default-agent-1'      
INFO[0013] Starting Node 'k3d-k3s-default-agent-0'      
INFO[0024] Starting helpers...                          
INFO[0024] Starting Node 'k3d-k3s-default-serverlb'     
INFO[0032] Injecting records for hostAliases (incl. host.k3d.internal) and for 5 network members into CoreDNS configmap... 
INFO[0035] Cluster 'k3s-default' created successfully!  
INFO[0035] You can now use it like this:                
kubectl cluster-info

(base) vuola@Markuss-MacBook-Air release % docker container ls
CONTAINER ID   IMAGE                            COMMAND                  CREATED             STATUS             PORTS                                                                    NAMES
c7fdd4de21b5   ghcr.io/k3d-io/k3d-tools:5.4.3   "/app/k3d-tools noop"    About an hour ago   Up About an hour                                                                            k3d-k3s-default-tools
9775883ddb26   ghcr.io/k3d-io/k3d-proxy:5.4.3   "/bin/sh -c nginx-pr…"   About an hour ago   Up About an hour   0.0.0.0:8081->80/tcp, 0.0.0.0:60253->6443/tcp, 0.0.0.0:8082->30080/tcp   k3d-k3s-default-serverlb
6c05fa4768cf   rancher/k3s:v1.23.6-k3s1         "/bin/k3d-entrypoint…"   About an hour ago   Up About an hour                                                                            k3d-k3s-default-agent-1
c803db870a8a   rancher/k3s:v1.23.6-k3s1         "/bin/k3d-entrypoint…"   About an hour ago   Up About an hour                                                                            k3d-k3s-default-agent-0
cf100b613b46   rancher/k3s:v1.23.6-k3s1         "/bin/k3d-entrypoint…"   About an hour ago   Up About an hour                                                                            k3d-k3s-default-server-0

(base) vuola@Markuss-MacBook-Air Exercise1_11 % docker exec k3d-k3s-default-agent-0 mkdir -p /tmp/kube

(base) vuola@Markuss-MacBook-Air logoutput % docker build . -t vuolahti/logoutput:02 --no-cache
[+] Building 45.7s (26/26) FINISHED                                                                                                                                                                                                                       
 => [internal] load build definition from Dockerfile                                                                                                                                                                                                 0.1s
 => => transferring dockerfile: 2.61kB                                                                                                                                                                                                               0.0s
 => [internal] load .dockerignore                                                                                                                                                                                                                    0.0s
 => => transferring context: 2B                                                                                                                                                                                                                      0.0s
 => [internal] load metadata for docker.io/library/alpine:3.16                                                                                                                                                                                       0.7s
 => [internal] load build context                                                                                                                                                                                                                    0.0s
 => => transferring context: 9.11kB                                                                                                                                                                                                                  0.0s
 => CACHED [build 1/7] FROM docker.io/library/alpine:3.16@sha256:686d8c9dfa6f3ccfc8230bc3178d23f84eeaf7e457f36f271ab1acc53015037c                                                                                                                    0.0s
 => CACHED [stage-1  2/15] WORKDIR /var/www/html                                                                                                                                                                                                     0.0s
 => [build 2/7] RUN apk add --no-cache   build-base   cmake   fmt-dev                                                                                                                                                                               15.4s
 => [build 3/7] WORKDIR /var/www/html                                                                                                                                                                                                                0.1s
 => [build 4/7] COPY CMakeLists.txt .                                                                                                                                                                                                                0.1s
 => [build 5/7] COPY main.cpp .                                                                                                                                                                                                                      0.0s
 => [build 6/7] RUN cmake -S . -B ./build                                                                                                                                                                                                            5.9s
 => [build 7/7] RUN cmake --build build                                                                                                                                                                                                             10.0s
 => [stage-1  3/15] COPY --from=build /var/www/html/build/logger ./build/logger                                                                                                                                                                      0.1s
 => [stage-1  4/15] RUN chmod a+x ./build/logger                                                                                                                                                                                                     0.5s
 => [stage-1  5/15] RUN apk add --no-cache   curl   nginx   php81   php81-ctype   php81-curl   php81-dom   php81-fpm   php81-gd   php81-intl   php81-mbstring   php81-mysqli   php81-opcache   php81-openssl   php81-phar   php81-session   php81-x  6.2s
 => [stage-1  6/15] RUN ln -s /usr/bin/php81 /usr/bin/php                                                                                                                                                                                            0.7s
 => [stage-1  7/15] COPY config/nginx.conf /etc/nginx/nginx.conf                                                                                                                                                                                     0.1s
 => [stage-1  8/15] COPY config/fpm-pool.conf /etc/php81/php-fpm.d/www.conf                                                                                                                                                                          0.0s
 => [stage-1  9/15] COPY config/php.ini /etc/php81/conf.d/custom.ini                                                                                                                                                                                 0.1s
 => [stage-1 10/15] COPY config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf                                                                                                                                                             0.0s
 => [stage-1 11/15] RUN chown -R nobody.nobody /var/www/html /run /var/lib/nginx /var/log/nginx                                                                                                                                                      0.8s
 => [stage-1 12/15] COPY --chown=nobody html/ /var/www/html/                                                                                                                                                                                         0.1s
 => [stage-1 13/15] COPY --chown=root html/file/ /var/www/html/file/                                                                                                                                                                                 0.1s
 => [stage-1 14/15] COPY myscript /var/www/script                                                                                                                                                                                                    0.4s
 => [stage-1 15/15] RUN chmod a+x /var/www/script/myscript.sh                                                                                                                                                                                        1.6s
 => exporting to image                                                                                                                                                                                                                               2.4s
 => => exporting layers                                                                                                                                                                                                                              2.4s
 => => writing image sha256:34d263df14c91b706ca63df45569d0e4a5d700124bc3e6f6aee52a5c0afbb828                                                                                                                                                         0.0s
 => => naming to docker.io/vuolahti/logoutput:02                                                                                                                                                                                                     0.0s
Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them

(base) vuola@Markuss-MacBook-Air logoutput % docker push vuolahti/logoutput:02                 
The push refers to repository [docker.io/vuolahti/logoutput]
05066958bd9e: Preparing 
73babedc0153: Preparing 
5f70bf18a086: Preparing 
4a56bae758d1: Preparing 
05066958bd9e: Pushed 
b99aec0b42bd: Pushed 
daa79a9ad131: Pushed 
f82afbc11f66: Pushed 
5d75813079cf: Pushed 
a45a12b573a8: Pushed 
e224fb7ce72e: Pushed 
ad7bd984080d: Pushed 
977224492190: Pushed 
d751d7402017: Layer already exists 
24302eb7d908: Layer already exists 
02: digest: sha256:1256d79826880262d2ea3abc90ed3895cde612ccae7d20447af4fbd72c2b1803 size: 3438

(base) vuola@Markuss-MacBook-Air pingpong % docker build . -t vuolahti/pingpong:03
[+] Building 6.2s (20/20) FINISHED                                                                                                                                                                                                 
 => [internal] load build definition from Dockerfile                                                                                                                                                                          0.2s
 => => transferring dockerfile: 2.04kB                                                                                                                                                                                        0.1s
 => [internal] load .dockerignore                                                                                                                                                                                             0.0s
 => => transferring context: 2B                                                                                                                                                                                               0.0s
 => [internal] load metadata for docker.io/library/alpine:3.16                                                                                                                                                                2.4s
 => [auth] library/alpine:pull token for registry-1.docker.io                                                                                                                                                                 0.0s
 => [internal] load build context                                                                                                                                                                                             0.0s
 => => transferring context: 6.75kB                                                                                                                                                                                           0.0s
 => [ 1/14] FROM docker.io/library/alpine:3.16@sha256:686d8c9dfa6f3ccfc8230bc3178d23f84eeaf7e457f36f271ab1acc53015037c                                                                                                        0.0s
 => CACHED [ 2/14] WORKDIR /var/www/html                                                                                                                                                                                      0.0s
 => CACHED [ 3/14] RUN apk add --no-cache   curl   nginx   php81   php81-ctype   php81-curl   php81-dom   php81-fpm   php81-gd   php81-intl   php81-mbstring   php81-mysqli   php81-opcache   php81-openssl   php81-phar   p  0.0s
 => CACHED [ 4/14] RUN ln -s /usr/bin/php81 /usr/bin/php                                                                                                                                                                      0.0s
 => [ 5/14] COPY config/nginx.conf /etc/nginx/nginx.conf                                                                                                                                                                      0.1s
 => [ 6/14] COPY config/fpm-pool.conf /etc/php81/php-fpm.d/www.conf                                                                                                                                                           0.1s
 => [ 7/14] COPY config/php.ini /etc/php81/conf.d/custom.ini                                                                                                                                                                  0.1s
 => [ 8/14] COPY config/supervisord.conf /etc/supervisor/conf.d/supervisord.conf                                                                                                                                              0.1s
 => [ 9/14] RUN chown -R nobody.nobody /var/www/html /run /var/lib/nginx /var/log/nginx                                                                                                                                       0.9s
 => [10/14] COPY --chown=nobody html/ /var/www/html/                                                                                                                                                                          0.1s
 => [11/14] RUN mkdir /tmp/kube                                                                                                                                                                                               0.5s
 => [12/14] RUN chmod a+rw /tmp/kube/                                                                                                                                                                                         0.5s
 => [13/14] COPY myscript /var/www/script                                                                                                                                                                                     0.1s
 => [14/14] RUN chmod a+x /var/www/script/myscript.sh                                                                                                                                                                         0.5s
 => exporting to image                                                                                                                                                                                                        0.3s
 => => exporting layers                                                                                                                                                                                                       0.3s
 => => writing image sha256:6ed5fe6773c051797abbfe064837f8c27805def3bc7000fce4a1e31acb2563b6                                                                                                                                  0.0s
 => => naming to docker.io/vuolahti/pingpong:03                                                                                                                                                                               0.0s

Use 'docker scan' to run Snyk tests against images to find vulnerabilities and learn how to fix them
(b

(base) vuola@Markuss-MacBook-Air release % docker push vuolahti/pingpong:03
The push refers to repository [docker.io/vuolahti/pingpong]
94f6cc1b439e: Pushed 
0d4e358d3485: Pushed 
0d79db33f645: Pushed 
17de50bb1c4a: Pushed 
c3bd29b86ba9: Pushed 
2943fd902d74: Pushed 
e0c32f7e7792: Pushed 
e9395a60f6e3: Pushed 
2db5bde1baaf: Pushed 
d8f4c57505b0: Pushed 
31ce32c182e4: Layer already exists 
f7d0c309c4a4: Layer already exists 
d751d7402017: Layer already exists 
24302eb7d908: Layer already exists 
03: digest: sha256:ec19dd098c0555e2a6f1fc9df6fa5976deeb9cc0abe26467f0496e36cbf5e1d8 size: 3226

(base) vuola@Markuss-MacBook-Air release % kubectl apply -f manifests/   
deployment.apps/project-dep created
ingress.networking.k8s.io/project-ingress created
persistentvolume/example-pv created
persistentvolumeclaim/image-claim created
service/project-svc created

CONTAINER LOGS

vuolahti/logoutput:03

Server started at port 8080
2022-07-13 08:16:25,074 INFO supervisord started with pid 1
2022-07-13 08:16:26,080 INFO spawned: 'nginx' with pid 10
2022-07-13 08:16:26,086 INFO spawned: 'php-fpm' with pid 11
2022-07-13 08:16:26,088 INFO reaped unknown pid 8 (exit status 0)
[13-Jul-2022 08:16:26] NOTICE: fpm is running, pid 11
[13-Jul-2022 08:16:26] NOTICE: ready to handle connections
2022-07-13 08:16:27,227 INFO success: nginx entered RUNNING state, process has stayed up for > than 1 seconds (startsecs)
2022-07-13 08:16:27,228 INFO success: php-fpm entered RUNNING state, process has stayed up for > than 1 seconds (startsecs)
172.17.0.1 - - [13/Jul/2022:08:16:47 +0000] "GET / HTTP/1.1" 200 108 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.5 Safari/605.1.15" "-" 0.003 0.003 . -
172.17.0.1 - - [13/Jul/2022:08:16:53 +0000] "GET / HTTP/1.1" 200 108 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.5 Safari/605.1.15" "-" 0.001 0.001 . -
vuolahti/pingpong:03

Server started at port 8081
2022-07-13 07:57:22,932 INFO supervisord started with pid 1
2022-07-13 07:57:23,940 INFO spawned: 'nginx' with pid 8
2022-07-13 07:57:23,949 INFO spawned: 'php-fpm' with pid 9
2022-07-13 07:57:23,950 INFO reaped unknown pid 7 (exit status 0)
[13-Jul-2022 07:57:24] NOTICE: fpm is running, pid 9
[13-Jul-2022 07:57:24] NOTICE: ready to handle connections
2022-07-13 07:57:25,018 INFO success: nginx entered RUNNING state, process has stayed up for > than 1 seconds (startsecs)
2022-07-13 07:57:25,018 INFO success: php-fpm entered RUNNING state, process has stayed up for > than 1 seconds (startsecs)
10.42.0.3 - - [13/Jul/2022:07:59:27 +0000] "GET /pingpong HTTP/1.1" 200 37 "-" "curl/7.79.1" "10.42.2.0" 0.008 0.008 . -
10.42.0.3 - - [13/Jul/2022:08:00:46 +0000] "GET /pingpong HTTP/1.1" 200 37 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.5 Safari/605.1.15" "10.42.0.1" 0.004 0.004 . -
10.42.0.3 - - [13/Jul/2022:08:00:54 +0000] "GET /pingpong HTTP/1.1" 200 37 "-" "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/15.5 Safari/605.1.15" "10.42.0.1" 0.001 0.001 . -

RESPONSE FROM SERVICE

(base) vuola@Markuss-MacBook-Air release % curl localhost:8081
2022-07-13 07:59:06Z fUWk0G31yaAjtZmEVhoglRurX6Icsi7J
 
<br />Ping / Pongs: 1
(base) vuola@Markuss-MacBook-Air release % curl localhost:8081
2022-07-13 07:59:16Z fUWk0G31yaAjtZmEVhoglRurX6Icsi7J
 
<br />Ping / Pongs: 1
(base) vuola@Markuss-MacBook-Air release % curl localhost:8081/pingpong
PONG 1%                                                                                                                                                                                                                            
(base) vuola@Markuss-MacBook-Air release % curl localhost:8081         
2022-07-13 07:59:31Z fUWk0G31yaAjtZmEVhoglRurX6Icsi7J
 
<br />Ping / Pongs: 2
